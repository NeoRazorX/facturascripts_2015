{include="header"}
<!--
Copyright (C) 2016 Joe Nilson <joenilson at gmail.com>

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU Lesser General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Lesser General Public License for more details.

You should have received a copy of the GNU Lesser General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<script type="text/javascript">
    $(document).ready(function() {

    });

    /**
     * Validamos si el formulario tiene datos correctos con páginas seleccionadas
     * @returns {Boolean}
     */
    function validar_paginas(){
        var le = document.querySelectorAll('#f_nueva_pagina_rol input[name="enabled[]"]:checked');
        if(le.length <= 0 ){
            valid = false;
            alert('¡Debes seleccionar por lo menos una página para agregar al rol!');
        }else{
            var valid = confirm('¿Esta seguro que quiere agregar estas páginas?');
        }
        return valid;
    }

    /**
     * Validamos si se selecciono un usuario como mínimo
     * @returns {Boolean}
     */
    function validar_usuarios(){
        var le = document.querySelectorAll('#f_nuevo_usuario_rol input[name="acceso[]"]:checked');
        if(le.length <= 0 ){
            valid = false;
            alert('¡Debes seleccionar por lo menos un usuario para agregar al rol!');
        }else{
            var valid = confirm('¿Esta seguro que quiere agregar estos usuarios?');
        }
        return valid;
    }

    function fs_marcar_todo(formulario,selector,plugin)
    {
        $("#"+formulario+" input[plugin='"+plugin+"_"+selector+"']").prop('checked', true);
    }
    function fs_marcar_nada(formulario,selector,plugin)
    {
        $("#"+formulario+" input[plugin='"+plugin+"_"+selector+"']").prop('checked', false);
    }
    function fs_marcar_todos(formulario,selector)
    {
        $("#"+formulario+" input[name='"+selector+"[]']").prop('checked', true);
    }
    function fs_marcar_nadie(formulario,selector)
    {
        $("#"+formulario+" input[name='"+selector+"[]']").prop('checked', false);
    }
</script>
<div class="container bg_load">
    <div class="row">
        <div id="loader">
        <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="lading">Cargando...</div>
        </div>
    </div>
</div>
<div class="container-fluid">
    <div class="row">
        <div class="col-sm-6 col-xs-7">
            <div class="btn-group">
                <a class="btn btn-sm btn-default" href="{$fsc->rol->url()}" title="Recargar la página">
                    <span class="glyphicon glyphicon-refresh"></span>
                </a>
                {if="$fsc->page->is_default()"}
                <a class="btn btn-sm btn-default active" href="{$fsc->url()}&amp;default_page=FALSE" title="desmarcar como página de inicio">
                    <span class="glyphicon glyphicon-home"></span>
                </a>
                {else}
                <a class="btn btn-sm btn-default" href="{$fsc->url()}&amp;default_page=TRUE" title="marcar como página de inicio">
                    <span class="glyphicon glyphicon-home"></span>
                </a>
                {/if}
            </div>
            <div class="btn-group">
                <a id="b_nuevo_rol" class="btn btn-sm btn-success" href="{#FS_PATH#}index.php?page=admin_roles#nuevo">
                    <span class="glyphicon glyphicon-plus"></span>
                    <span class="hidden-xs">&nbsp;Nuevo Rol</span>
                </a>

                {loop="$fsc->extensions"}
                {if="$value->type=='button'"}
                <a href="index.php?page={$value->from}{$value->params}" class="btn btn-sm btn-default">{$value->text}</a>
                {/if}
                {/loop}
            </div>
            <a href="{#FS_PATH#}index.php?page=admin_roles" class="btn btn-sm btn-default">
                <span class="fa fa-arrow-left"></span>
                <span class="hidden-xs">&nbsp;Regresar a Roles</span>
            </a>
        </div>
        <div class="col-sm-6 col-xs-5 text-right">
            <h2 style="margin-top: 0px;"><span class="fa fa-tasks"></span>&nbsp;Rol: {$fsc->rol->descripcion}</h2>
        </div>
    </div>
</div>
<div role="tabpanel">
    <ul class="nav nav-tabs" role="tablist">
        <li role="presentation" class="active">
            <a href="#paginas" aria-controls="paginas" role="tab" data-toggle="tab">
                <i class="fa fa-files-o" aria-hidden="true"></i>
                <span class="hidden-xs">&nbsp; Páginas</span>
                <span class="badge">{$fsc->rol->accesos()}</span>
            </a>
        </li>
        <li role="presentation">
            <a href="#usuarios" aria-controls="usuarios" role="tab" data-toggle="tab">
                <span class="fa fa-users" aria-hidden="true"></span>
                <span class="hidden-xs">&nbsp; Usuarios</span>
                <span class="badge">{$fsc->rol->asignaciones()}</span>
            </a>
        </li>
    </ul>
    <div class="tab-content">
        <div role="tabpanel" class="tab-pane active" id="paginas">
            <div class="container-fluid" style="margin-top: 10px;">
                <button type="button" id="btn_add_pages" class="btn btn-sm btn-primary" data-toggle="modal" data-target="#modal_nueva_pagina">
                    <span class="fa fa-plus-circle"></span>&nbsp;Agregar páginas
                </button>
            </div>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th class="text-left">Plugin</th>
                            <th class="text-left">Pagina</th>
                            <th class="text-left">Eliminar</th>
                            <th class="text-left">Estado</th>
                            <th class="text-left">Fecha de Creacion</th>
                            <th class="text-left">Usuario Creacion</th>
                            <th class="text-left">Ultima modicación</th>
                            <th class="text-left">Usuario modificó</th>
                            <th></th>
                        </tr>
                    </thead>
                    {loop="$fsc->rol->get_pages()"}
                    <form id="f_paginas_rol" name="f_paginas_rol" class="form" role="form" action="{$fsc->url()}&id={$fsc->id}" method="post">
                    <tr class='{if="!$value->estado"} warning{/if}'>
                        <td>
                            {$value->plugin}
                        </td>
                        <td>
                            <input type="hidden" name="enabled" value="{$value->name}">
                            {$value->name}
                        </td>
                        <td><input type="checkbox" name="allow_delete" value="TRUE" {if="$value->allow_delete"}checked{/if}></td>
                        <td><input type="checkbox" name="estado" value="TRUE" {if="$value->estado"}checked{/if}></td>
                        <td>{$value->fecha_creacion}</td>
                        <td>{$value->usuario_creacion}</td>
                        <td>{$value->fecha_modificacion}</td>
                        <td>{$value->usuario_modificacion}</td>
                        <td>
                            <button type="submit" class="btn btn-sm btn-danger" name="accion" value="eliminar_pagina" onclick="return confirm('¿Esta seguro que quiere eliminar la página {$value->name} de este rol?')"><span class="fa fa-trash"></span></button>
                            <button type="button" class="btn btn-sm btn-primary" name="accion" value="actualizar_pagina"><span class="fa fa-save"></span></button>
                        </td>
                    </tr>
                    </form>
                    {/loop}
                </table>
            </div>
            <div class="container-fluid">
                <div class="row">
                    <div class="col-sm-12">
                        <p class="help-block">
                            <span class="glyphicon glyphicon-info-sign" aria-hidden="true"></span>
                            No es obligatorio el uso de Roles, puedes asignar los accesos directamente desde la página de <strong>Usuarios</strong>.
                        </p>
                    </div>
                </div>
            </div>
        </div>
        <div role="tabpanel" class="tab-pane" id="usuarios">
            <div class="container-fluid" style="margin-top: 10px;">
                <button type="button" id="btn_add_users" class="btn btn-sm btn-primary" data-toggle="modal" data-target="#modal_nuevo_usuario">
                    <span class="fa fa-plus-circle"></span>&nbsp;Agregar usuarios
                </button>
            </div>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th class="text-left">Usuario</th>
                            <th class="text-left">Estado</th>
                            <th class="text-left">Fecha de Creacion</th>
                            <th class="text-left">Usuario Creacion</th>
                            <th class="text-left">Ultima modicación</th>
                            <th class="text-left">Usuario modificó</th>
                            <th></th>
                        </tr>
                    </thead>
                    {loop="$fsc->rol->get_users()"}
                    <form id="f_usuarios_rol" name="f_usuarios_rol" class="form" role="form" action="{$fsc->url()}&id={$fsc->id}" method="post">
                    <tr class='{if="!$value->estado"} warning{/if}'>
                        <td>
                            <input type="hidden" name="acceso" value="{$value->nick}">
                            {$value->nick}
                        </td>
                        <td><input type="checkbox" name="estado" value="TRUE" {if="$value->estado"}checked{/if}></td>
                        <td>{$value->fecha_creacion}</td>
                        <td>{$value->usuario_creacion}</td>
                        <td>{$value->fecha_modificacion}</td>
                        <td>{$value->usuario_modificacion}</td>
                        <td>
                            <button type="submit" class="btn btn-sm btn-danger" name="accion" value="eliminar_usuario" onclick="return confirm('¿Esta seguro que quiere eliminar al usuario {$value->nick} de este rol?')"><span class="fa fa-trash"></span></button>
                            <button type="button" class="btn btn-sm btn-primary" name="accion" value="actualizar_usuario"><span class="fa fa-save"></span></button>
                        </td>
                    </tr>
                    </form>
                    {/loop}
                </table>
            </div>
            <div class="container-fluid">
                <div class="row">
                    <div class="col-sm-12">
                        <p class="help-block">
                            <span class="glyphicon glyphicon-info-sign" aria-hidden="true"></span>
                            No es obligatorio el uso de Roles, puedes asignar los accesos directamente desde la página de <strong>Usuarios</strong>.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal" id="modal_nueva_pagina">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title">
                    <i class="fa fa-tasks" aria-hidden="true"></i>&nbsp; Agregar Páginas
                </h4>
            </div>
            <form id="f_nueva_pagina_rol" name="f_nueva_pagina_rol" class="form" role="form" action="{$fsc->url()}&id={$fsc->id}" method="post">
                <div class="modal-body">
                    <h5>Páginas a Autorizar por plugin:</h5>
                    <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
                        {loop="$fsc->plugins"}
                        {if="count($fsc->mostrar_paginas('disponibles',$value))!=0"}
                        <div class="panel panel-default">
                            <div class="panel-heading" role="tab" id="plugin{$counter}">
                                <h6 class="panel-title">
                                    <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapse{$counter}" aria-expanded="true" aria-controls="collapse{$counter}">
                                        Plugin: {$value}
                                    </a>
                                </h6>
                            </div>
                            <div id="collapse{$counter}" class="panel-collapse collapse {if="$counter==0"}in{/if}" role="tabpanel" aria-labelledby="plugin{$counter}">
                                <div class="panel-body">
                                    <div class="table-responsive">
                                        <table class="table table-fixed">
                                            <thead>
                                                <th class="col-xs-6 col-sm-6">
                                                    Pagina
                                                </th>
                                                <th class="col-xs-3 col-sm-3 text-center">
                                                    Ver/Modificar<br>
                                                    <span class="text-center">
                                                        <div class="btn-group">
                                                            <button class="btn btn-xs btn-default" type="button" onclick="fs_marcar_todo('f_nueva_pagina_rol','enabled','{$value1}')" title="Marcar todo">
                                                                <span class="glyphicon glyphicon-check"></span>
                                                            </button>
                                                            <button class="btn btn-xs btn-default" type="button" onclick="fs_marcar_nada('f_nueva_pagina_rol','enabled','{$value1}')" title="Desmarcar todo">
                                                                <span class="glyphicon glyphicon-unchecked"></span>
                                                            </button>
                                                        </div>
                                                    </span>
                                                </th>
                                                <th class="col-xs-3 col-sm-3 text-center">
                                                    Eliminar<br>
                                                    <span class="text-center">
                                                        <div class="btn-group">
                                                            <button class="btn btn-xs btn-default" type="button" onclick="fs_marcar_todo('f_nueva_pagina_rol','allow_delete','{$value1}')" title="Marcar todo">
                                                                <span class="glyphicon glyphicon-check"></span>
                                                            </button>
                                                            <button class="btn btn-xs btn-default" type="button" onclick="fs_marcar_nada('f_nueva_pagina_rol','allow_delete','{$value1}')" title="Desmarcar todo">
                                                                <span class="glyphicon glyphicon-unchecked"></span>
                                                            </button>
                                                        </div>
                                                    </span>
                                                </th>
                                            </thead>
                                            <tbody>
                                                {loop="$fsc->mostrar_paginas('disponibles',$value)"}
                                                <tr>
                                                    <td class="col-sm-6">
                                                        {$value2->folder} > {$value2->name}
                                                    </td>
                                                    <td class="col-sm-3 text-center">
                                                        <input type="checkbox" id="enabled_{$counter2}" plugin="{$value1}_enabled" name="enabled[]" value="{$value2->name}"/>
                                                    </td>
                                                    <td class="col-sm-3 text-center">
                                                        <input type="checkbox" id="allow_delete_{$counter2}" plugin="{$value1}_allow_delete" name="allow_delete[]" value="{$value2->name}"/>
                                                    </td>
                                                </tr>
                                                {/loop}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {/if}
                        {/loop}
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="row">
                        <div class="col-sm-8 pull-left">
                            <span class="help-block text-left">
                                <span class="fa fa-info-circle"></span>&nbsp;Al agregar páginas se actualizarán los accesos de los usuarios de este Rol.
                            </span>
                        </div>
                        <div class="col-sm-4 pull-right">
                            <button type="submit" class="btn btn-sm btn-primary" name="accion" value="agregar_pagina" onclick="return validar_paginas()"><span class="fa fa-save"></span>&nbsp;Guardar</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
<div class="modal" id="modal_nuevo_usuario">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title">
                    <i class="fa fa-users" aria-hidden="true"></i>&nbsp; Agregar Usuarios
                </h4>
            </div>
            <form id="f_nuevo_usuario_rol" name="f_nueva_pagina_rol" class="form" role="form" action="{$fsc->url()}&id={$fsc->id}" method="post">
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-fixed">
                       <thead>
                          <tr>
                             <th class="col-sm-3 text-left">Nick</th>
                             <th class="col-sm-2 text-left">Email</th>
                             <th class="col-sm-3 text-left">Empleado</th>
                             <th class="col-sm-2 text-center">Administrador</th>
                             <th class="col-sm-2 text-center">
                                <div class="btn-group">
                                    <button class="btn btn-xs btn-default" type="button" onclick="fs_marcar_todos('f_nuevo_usuario_rol','acceso')" title="Marcar todo">
                                        <span class="glyphicon glyphicon-check"></span>
                                    </button>
                                    <button class="btn btn-xs btn-default" type="button" onclick="fs_marcar_nadie('f_nuevo_usuario_rol','acceso')" title="Desmarcar todo">
                                        <span class="glyphicon glyphicon-unchecked"></span>
                                    </button>
                                </div>
                             </th>
                          </tr>
                       </thead>
                       {loop="$fsc->mostrar_usuarios('disponibles')"}
                       <tr>
                          <td class="col-xs-3 col-sm-3">{$value->nick}</td>
                          <td class="col-xs-3 col-sm-2">{if="FS_DEMO"}XXX@XXX.com{else}{$value->email}{/if}</td>
                          <td class="col-xs-3 col-sm-3">{$value->get_agente_fullname()}</td>
                          <td class="col-xs-1 col-sm-2 text-center">
                             {if="$value->admin"}<span class="glyphicon glyphicon-ok"></span>{/if}
                          </td>
                          <td class="col-sm-2 text-center">
                              {if="!$value->admin"}
                              <input type="checkbox" name="acceso[]" value="{$value->nick}">
                              {/if}
                          </td>
                       </tr>
                       {/loop}
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <div class="row">
                    <div class="col-sm-8 pull-left">
                        <span class="help-block text-left">
                            <span class="fa fa-info-circle"></span>&nbsp;Al agregar usuarios se les asignarán las páginas de este Rol.
                        </span>
                    </div>
                    <div class="col-sm-4 pull-right">
                        <button type="submit" class="btn btn-sm btn-primary" onclick="return validar_usuarios()" name="accion" value="agregar_usuario"><span class="fa fa-save"></span>&nbsp;Guardar</button>
                    </div>
                </div>
            </div>
            </form>
        </div>
    </div>
</div>
<!-- INICIO DIV PARA LOADER
<div class="bg_load"></div>
<div class="wrapper">
    <div class="inner">
        <span>C</span>
        <span>a</span>
        <span>r</span>
        <span>g</span>
        <span>a</span>
        <span>n</span>
        <span>d</span>
        <span>o</span>
    </div>
</div>
FIN DIV PARA LOADER !-->
{include="footer"}